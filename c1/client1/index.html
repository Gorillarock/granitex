<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="src/style.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.js"></script>
    <script>
      let cNonce = "";
      let hNonce_1 = "";
      let hNonce_2 = "";
      let eMsg = "";
      function get_cNonce() {
        const array = new Uint8Array(16);
        return self.crypto.getRandomValues(array).join("");
      }
      function encrypt(cMsg, Pin) {
        const eMsg = CryptoJS.AES.encrypt(cMsg.toString(), Pin.toString());
        return eMsg.toString();
      }
      function sha512(value, key) {
        const hash = CryptoJS.SHA512(value + key);
        return hash.toString();
      }
      
      function submit() {
        const cMsg = document.getElementById("box.cMsg").value.toString();
        const Pin = document.getElementById("box.pin.1").value.toString();
        cNonce = get_cNonce();
        eMsg = encrypt(cMsg, Pin);
        hNonce_1 = sha512(cNonce, Pin);
        console.log("cMsg: " + cMsg);
        console.log("eMsg: " + eMsg);
        console.log("cNonce.1: " + cNonce);
        console.log("Pin: " + Pin);
        console.log("hNonce_1: " + hNonce_1);
        const id = crypto.randomUUID();  // simulate coming from the server
        document.getElementById("p.output").textContent = `URL: path/v1/rx?i=${id}&c=${cNonce}`;
      }
      function get() {
        const pin = document.getElementById("box.pin.2").value.toString();
        hNonce_2 = sha512(cNonce, pin);
        console.log("cNonce.2: " + cNonce);
        console.log("Pin.2: " + pin);
        console.log("hNonce_2: " + hNonce_2);
        console.log("hNonce_1 = " + hNonce_1 + " hNonce_2 = " + hNonce_2);
        return hNonce_2;
      }
      function fakeServer(hNonce_1, hNonce_2) {
        if (hNonce_1 === hNonce_2) {
          console.log("fakeServer = eMsg: " + eMsg);
          return eMsg;
        }
        return "";
      }
      function decrypt(eVal, key) {
        const dMsg = CryptoJS.AES.decrypt(eVal, key);
        return dMsg.toString(CryptoJS.enc.Utf8);
      }
      function obtain() {
        const testHnonce = get();
        const eMsg = fakeServer(hNonce_1, testHnonce);
        if (eMsg === "") {
          console.log("Error: hNonce_1 != hNonce_2");
          return;
        }
        console.log("eMsg: " + eMsg);
        document.getElementById("p.output.2").textContent = decrypt(eMsg, document.getElementById("box.pin.2").value.toString());
        return;
      }
    </script>
  </head>
  <body>
    <div>
      <form>
        <h1 id="box.Com">Enter Message and Pin</h1>
        <input
        type="text"
        id="box.cMsg"
        placeholder="Message"
        /><br />
        <input
        type="text"
        id="box.pin.1"
        placeholder="PIN"
        />
      </form>
      <button type="button.Submit" onclick="submit()">Submit</button>
      <div>
        <label>output</label>
        <p id="p.output"></p>
      </div>
      <div>
        <!-- TODO: move client 2 -->
        <form>
          <h2>"Decrypt</h2>
          <input
          type="text"
          id="box.pin.2"
          placeholder="PIN"/>
        </form>
        <button type="button.Get" onclick="obtain()">Get</button>
        <div>
          <p id="p.output.2"></p>
      </div>
    </div>
  </body>
</html>
